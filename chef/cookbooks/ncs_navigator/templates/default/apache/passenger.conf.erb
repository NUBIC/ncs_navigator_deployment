<VirtualHost *:443>
  SSLEngine on
  SSLCertificateFile <%= @ssl_certificate %>
  SSLCertificateKeyFile <%= @ssl_key %>

  <% if @ssl_certificate_chain %>
  SSLCertificateChainFile <%= @ssl_certificate_chain %>
  <% end %>

  ServerName <%= @host %>
  DocumentRoot <%= @app_root %>/current/public
  RailsEnv <%= @env %>
  SetEnv <%= @secret_token_env_var %> "<%= @secret_token %>"
  <% if @min_instances %>
  PassengerMinInstances <%= @min_instances %>
  <% end %>

  ErrorDocument 410 /offline.html

  RewriteEngine on

  # If it's not from us, block it.
  RewriteCond %{REMOTE_ADDR} !^165.124.223.*
  RewriteCond %{DOCUMENT_ROOT}/%{REQUEST_FILENAME} !-f
  RewriteRule ^(.*)$ /$1 [R=410,L]

  <Directory <%= @app_root %>/current/public>
    Allow from all
    Options -MultiViews
    XSendFile on
    XSendFilePath <%= @app_root %>
  </Directory>
</VirtualHost>

PassengerPreStart <%= @uri %>
